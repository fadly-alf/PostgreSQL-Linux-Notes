#!/bin/bash#!/bin/bash
# Copyright 2007-2022 Equnix Business Solutions,PT. All rights reserved
# Script compile by: Iyan Iskandar
# Developed by: Equnix Technical Team
# "-------------------------------------------------------------------"
# "|                    Database Synchronization                |"
# "|                    XL                                         |"
# "|                    202208                                  |"
# "-------------------------------------------------------------------"
#echo "---------------------- EQUNIX BUSINESS SOLUTIONS -----------------------";
#echo "|                                                                      |"
#echo "|                        DB RESYNC SCRIPTS                               |"
#echo "|                                                                      |"
#echo "------------------------------------------------------------------------";

#VIP=192.168.8.100
MASTER_HOST=node2
BINDIR=/equnix/apps/12/bin
PG_DATA_DIR=/equnix/data
PG_WAL_DIR=/equnix/wal
PG_TBLSPC1=/equnix/tblspc1
PG_TBLSPC2=/equnix/tblspc2
PG_PORT=5432
PG_USER=pgsql
OS_USER=pgsql
LOG_FILE=/equnix/scripts/logs/dbresync_$(date '+%Y%m%d').log
export PGPASSFILE='/equnix/scripts/.pgpass';

logger (){
        # logger <message>
        echo "$(date +'%F %T')|$(hostname)|$1" >> "$LOG_FILE";
}

dbexec(){
        # dbexec <port> <query>
        $BINDIR/psql -At -h $MASTER_HOST -U $PG_USER postgres -p $PG_PORT -c "$1"
}

IS_NODE_MASTER=$(/usr/sbin/ip a | grep -c $VIP)
if [ "$IS_NODE_MASTER" -ge 1 ];
then
        echo "---------------------- EQUNIX BUSINESS SOLUTIONS -----------------------";
        echo "|                                                                       |"
        echo "|         Warning!!! Virtual IP is exists this node is primary!           |"
        echo "|                                                                       |"
        echo "------------------------------------------------------------------------";
        exit 0;
fi

if [ -f $PG_DATA_DIR/promote_standby ]; then
        logger "Removing trigger_file on this nodes $(hostname)";
        rm $PG_DATA_DIR/activate_standby
: